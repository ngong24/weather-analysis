name: Weekly Weather Model Training

on:
  # Chạy mỗi Chủ nhật lúc 2:00 sáng (UTC)
  schedule:
    - cron: '0 2 * * 0'
  
  # Cho phép chạy thủ công từ GitHub UI
  workflow_dispatch:
    inputs:
      days_back:
        description: 'Number of days to fetch (default: 3650 = 10 years)'
        required: false
        default: '3650'

permissions:
  contents: write

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Collect weather data
        id: collect
        run: |
          echo "Starting data collection..."
          python scripts/collect_data.py ${{ github.event.inputs.days_back || '3650' }}
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: false
      
      - name: Preprocess data
        id: preprocess
        run: |
          echo "Starting preprocessing..."
          python scripts/preprocessing.py
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: false
      
      - name: Train models
        id: train
        run: |
          echo "Starting model training..."
          python scripts/train_model.py
          echo "status=success" >> $GITHUB_OUTPUT
        continue-on-error: false
      
      - name: Evaluate model
        id: evaluate
        run: |
          echo "Starting model evaluation..."
          python scripts/evaluate_model.py 0.75 2.5
          echo "status=pass" >> $GITHUB_OUTPUT
          
          # Đọc metrics bằng Python
          python << 'PYTHON_SCRIPT'
          import json
          import os
          with open('model/training_results.json') as f:
              data = json.load(f)
              r2 = data['temperature']['r2']
              mae = data['temperature']['mae']
              print(f'r2={r2}')
              print(f'mae={mae}')
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'r2={r2}\n')
              f.write(f'mae={mae}\n')
          PYTHON_SCRIPT
        continue-on-error: false
      
      - name: Commit and push new model
        if: steps.evaluate.outputs.status == 'pass'
        run: |
          cd ..
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add backend/model/*.pkl backend/model/*.json backend/model/*.png
          
          git diff --staged --quiet || git commit -m "Auto-update model (R²=${{ steps.evaluate.outputs.r2 }}, MAE=${{ steps.evaluate.outputs.mae }}°C)

          Training completed at $(date -u +"%Y-%m-%d %H:%M UTC")
          - Temperature R²: ${{ steps.evaluate.outputs.r2 }}
          - Temperature MAE: ${{ steps.evaluate.outputs.mae }}°C

          [skip ci]"
          
          git push || echo "Nothing to push"
      
      - name: Create Release
        if: steps.evaluate.outputs.status == 'pass'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: model-v${{ github.run_number }}
          name: Model Training v${{ github.run_number }}
          body: |
            ## Automated Model Training Results
            
            **Training Date:** ${{ github.event.repository.updated_at }}
            
            ### Performance Metrics
            - **Temperature R²:** ${{ steps.evaluate.outputs.r2 }}
            - **Temperature MAE:** ${{ steps.evaluate.outputs.mae }}°C
            
            ### Data Coverage
            - **Data Range:** 10 years of historical data
            - **Training Method:** Time Series Cross-Validation (5 folds)
            
            This model has been automatically validated and deployed.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-artifacts
          path: |
            backend/model/*.pkl
            backend/model/*.json
            backend/model/*.png
            backend/data/*.csv
          retention-days: 30
      
      - name: Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## Training Pipeline Summary
          
          | Step | Status |
          |------|--------|
          | Data Collection | ${{ steps.collect.outputs.status || 'skipped' }} |
          | Preprocessing | ${{ steps.preprocess.outputs.status || 'skipped' }} |
          | Model Training | ${{ steps.train.outputs.status || 'skipped' }} |
          | Model Evaluation | ${{ steps.evaluate.outputs.status || 'skipped' }} |
          
          EOF
          
          if [ "${{ steps.evaluate.outputs.status }}" = "pass" ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ### Model Deployed Successfully!
          
          **Metrics:**
          - R² Score: ${{ steps.evaluate.outputs.r2 }}
          - MAE: ${{ steps.evaluate.outputs.mae }}°C
          EOF
          else
            echo "###  Training completed with issues" >> $GITHUB_STEP_SUMMARY
          fi